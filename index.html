<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>المُصرّف الخبير للأفعال الفارسية (الإصدار النهائي)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Vazirmatn:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --card-bg-color: rgba(255, 255, 255, 0.65);
            --primary-color: #4a6cf7;
            --primary-light: #eef2ff;
            --danger-color: #dc3545;
            --danger-light: #f8d7da;
            --text-dark: #1e293b;
            --text-light: #637381;
            --border-color: rgba(255, 255, 255, 0.25);
            --shadow-color: rgba(74, 108, 247, 0.15);
        }

        @keyframes animated-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        *, *::before, *::after {
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html { height: 100%; overflow: hidden; }

        body {
            display: flex;
            flex-direction: column;
            height: 100%;
            margin: 0;
            font-family: 'Cairo', 'Tahoma', sans-serif;
            font-weight: 400;
            color: var(--text-dark);
            background: linear-gradient(-45deg, #eef2f7, #e0eaff, #d1ecf1, #c5f0e9);
            background-size: 400% 400%;
            animation: animated-gradient 15s ease infinite;
        }

        .persian-text { font-family: 'Vazirmatn', sans-serif; font-weight: 400; }
        .fw-bold { font-weight: 700 !important; }

        .fixed-header, .fixed-footer {
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 10;
            border-bottom: 1px solid var(--border-color);
        }
        .fixed-header h1 {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            margin: 12px 0;
        }
        .fixed-footer { border-bottom: none; border-top: 1px solid var(--border-color); }
        .fixed-footer p { text-align: center; margin: 15px 0; color: var(--text-light); font-size: 14px; }

        #scroll-wrapper { flex-grow: 1; overflow-y: auto; padding: 25px 15px; }

        #main-container {
            background: var(--card-bg-color);
            padding: 30px 35px;
            border-radius: 24px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 10px 40px var(--shadow-color);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            transition: all 0.3s ease;
        }

        h2 {
            font-size: 20px;
            font-weight: 600;
            margin: 25px 0 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            color: var(--text-dark);
        }
        h2:first-of-type { margin-top: 0; }
        
        #verb-select, #verb-input {
            width: 100%;
            padding: 14px 18px;
            font-size: 17px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.1);
            background-color: rgba(255, 255, 255, 0.8);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #verb-select:focus, #verb-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
            background-color: #fff;
        }
        #verb-input { direction: ltr; text-align: right; }

        #conjugate-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 16px;
            margin-top: 15px;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            background: linear-gradient(45deg, var(--primary-color), #6a82fb);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #conjugate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(74, 108, 247, 0.3);
        }
        #conjugate-btn:active { transform: translateY(0); }
        #conjugate-btn .loader {
            width: 18px; height: 18px;
            border: 2px solid #fff;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: none;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #results-container {
            margin-top: 25px;
            transition: all 0.5s ease;
        }
        .hidden-results {
            opacity: 0;
            transform: translateY(20px);
            max-height: 0;
            overflow: hidden;
        }
        .visible-results {
            opacity: 1;
            transform: translateY(0);
            max-height: 1500px; /* A large enough value */
        }
        
        .notification {
            text-align: center;
            margin-bottom: 20px;
            padding: 14px;
            border-radius: 10px;
            display: none;
        }
        #correction-notice { background-color: var(--primary-light); color: var(--primary-color); border: 1px solid var(--primary-color); }
        #verb-info { background-color: #f8f9fa; border: 1px solid rgba(0,0,0,0.1); font-size: 15px; }
        #error-notice { background-color: var(--danger-light); color: var(--danger-color); border: 1px solid var(--danger-color); }
        
        .table-responsive { width: 100%; overflow-x: auto; border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; }
        #conjugation-table {
            width: 100%;
            border-collapse: collapse;
        }
        #conjugation-table th, #conjugation-table td {
            border: none;
            padding: 14px;
            text-align: center;
            font-size: 16px;
            vertical-align: middle;
        }
        #conjugation-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        #conjugation-table tbody tr:nth-child(even) { background-color: rgba(238, 242, 255, 0.7); }
        #conjugation-table tbody tr:hover { background-color: rgba(226, 232, 240, 0.8); }
        #conjugation-table td.pronoun-col { font-weight: 600; color: var(--text-dark); }
        #conjugation-table td small { color: var(--text-light); font-size: 12px; }

        #examples-section { margin-top: 30px; padding-top: 25px; border-top: 1px dashed rgba(0,0,0,0.1); }
        #example-options { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        #example-options button {
            background: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 10px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        #example-options button:hover { background-color: var(--primary-color); color: #fff; }

        #sentences-container {
            margin-top: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 12px;
            display: none;
        }
        #sentences-container ul { list-style-type: none; padding: 0; margin: 0; }
        #sentences-container li { font-size: 17px; padding: 12px 0; border-bottom: 1px solid #e9ecef; }
        #sentences-container li:last-child { border-bottom: none; }
        .arabic-translation { color: var(--text-light); font-size: 14px; margin-right: 10px;}

        @media (max-width: 768px) {
            #scroll-wrapper { padding: 20px 10px; }
            .fixed-header h1 { font-size: 20px; }
            #main-container { padding: 20px 15px; }
            h2 { font-size: 18px; }
        }
    </style>
</head>
<body>
    <header class="fixed-header"><h1 class="persian-text">المُصرّف الخبير للأفعال الفارسية</h1></header>
    
    <div id="scroll-wrapper">
        <div id="main-container">
            <div id="controls-container">
                <h2 class="persian-text">۱. انتخاب از لیست</h2>
                <div class="input-section"><select id="verb-select" class="persian-text"></select></div>
                
                <h2 class="persian-text">۲. یا نوشتن مصدر فعل</h2>
                <div class="input-section">
                    <input type="text" id="verb-input" class="persian-text" placeholder="اكتب أي مصدر فعل... سيتم تصحيح الحروف تلقائياً">
                    <button id="conjugate-btn">
                        <span id="btn-text">صَرّف الفعل</span>
                        <div class="loader"></div>
                    </button>
                </div>
            </div>
            
            <div id="error-notice" class="notification"></div>
            <div id="results-container" class="hidden-results">
                <div id="correction-notice" class="notification"></div>
                <div id="verb-info" class="notification"></div>
                <div class="table-responsive"><table id="conjugation-table"><thead ><tr><th class="pronoun-col">الضمير</th><th class="persian-text">ماضی ساده</th><th class="persian-text">حال اخباری</th><th class="persian-text">امر</th></tr></thead><tbody id="table-body" class="persian-text"></tbody></table></div>
                <div id="examples-section">
                    <div id="example-options">
                        <button id="present-examples-btn" class="persian-text">جملات حال (مضارع)</button>
                        <button id="past-examples-btn" class="persian-text">جملات گذشته (ماضی)</button>
                    </div>
                    <div id="sentences-container"></div>
                </div>
            </div>
        </div>
    </div>

    <footer class="fixed-footer"><p>تم التطوير بواسطة الذكاء الاصطناعي | الإصدار الخبير 2024</p></footer>

    <script>
        // --- DATA (بدون تغيير) ---
        const pronouns = [ { fa: "من", ar: "أنا" }, { fa: "تو", ar: "أنت" }, { fa: "او", ar: "هو/هي" }, { fa: "ما", ar: "نحن" }, { fa: "شما", ar: "أنتم" }, { fa: "آنها", ar: "هم" } ];
        const verbStems = {"آفریدن":"آفرین","آمدن":"آ","آوردن":"آور","انداختن":"انداز","ایستادن":"ایست","باز کردن":"باز کن","بازی کردن":"بازی کن","باور کردن":"باور کن","بخشیدن":"بخش","بردن":"بر","بستن":"بند","بلند کردن":"بلند کن","به یاد آوردن":"به یاد آور","بودن":"باش","پذیرفتن":"پذیر","پریدن":"پر","پرسیدن":"پرس","پیدا کردن":"پیدا کن","پوشیدن":"پوش","ترسیدن":"ترس","تنظیم کردن":"تنظیم کن","توانستن":"توان","توضیح دادن":"توضیح ده","جنگیدن":"جنگ","حرکت کردن":"حرکت کن","خواستن":"خواه","خواندن":"خوان","خریدن":"خر","خندیدن":"خند","خوابیدن":"خواب","خوردن":"خور","دادن":"ده","داشتن":"دار","دانستن":"دان","دنبال کردن":"دنبال کن","دویدن":"دو","دیدن":"بین","راه رفتن":"راه رو","رفتن":"رو","زنگ زدن":"زنگ زن","زندگی کردن":"زندگی کن","ساختن":"ساز","ستدن":"ستان","سخن گفتن":"سخن گو","سعی کردن":"سعی کن","سفر کردن":"سفر کن","شناختن":"شناس","شنیدن":"شنو","شدن":"شو","شروع کردن":"شروع کن","شکستن":"شکن","صحبت کردن":"صحبت کن","فروختن":"فروش","فکر کردن":"فکر کن","فهمیدن":"فهم","کار کردن":"کار کن","کشتن":"کش","کمک کردن":"کمک کن","کنار زدن":"کنار زن","گذاشتن":"گذار","گرفتن":"گیر","گفتن":"گو","گم شدن":"گم شو","گم کردن":"گم کن","گوش دادن":"گوش ده","مردن":"میر","نشستن":"نشین","نگاه کردن":"نگاه کن","نوشتن":"نویس","یاد دادن":"یاد ده","یاد گرفتن":"یاد گیر","انتخاب کردن":"انتخاب کن","احساس کردن":"احساس کن","استفاده کردن":"استفاده کن"};
        const verbMeanings = {"آفریدن":"الخلق","آمدن":"المجيء","آوردن":"الإحضار","انداختن":"الرمي","ایستادن":"الوقوف","باز کردن":"الفتح","بازی کردن":"اللعب","باور کردن":"التصديق","بخشیدن":"المسامحة","بردن":"الأخذ","بستن":"الإغلاق","بلند کردن":"الرفع","به یاد آوردن":"التذكر","بودن":"الكينونة","پذیرفتن":"القبول","پریدن":"القفز","پرسیدن":"السؤال","پیدا کردن":"الإيجاد","پوشیدن":"اللبس","ترسیدن":"الخوف","تنظیم کردن":"التنظيم","توانستن":"الاستطاعة","توضیح دادن":"الشرح","جنگیدن":"القتال","حرکت کردن":"التحرك","خواستن":"الإرادة/الطلب","خواندن":"القراءة","خریدن":"الشراء","خندیدن":"الضحك","خوابیدن":"النوم","خوردن":"الأكل","دادن":"الإعطاء","داشتن":"الملكية","دانستن":"المعرفة","دنبال کردن":"المتابعة","دویدن":"الركض","دیدن":"الرؤية","راه رفتن":"المشي","رفتن":"الذهاب","زنگ زدن":"الاتصال","زندگی کردن":"العيش","ساختن":"الصنع","ستدن":"الأخذ (قديم)","سخن گفتن":"التحدث","سعی کردن":"المحاولة","سفر کردن":"السفر","شناختن":"التعرف","شنیدن":"السماع","شدن":"الصيورة","شروع کردن":"البدء","شکستن":"الكسر","صحبت کردن":"التكلم","فروختن":"البيع","فکر کردن":"التفكير","فهمیدن":"الفهم","کار کردن":"العمل","کشتن":"القتل","کمک کردن":"المساعدة","کنار زدن":"الإزاحة","گذاشتن":"الوضع","گرفتن":"الأخذ","گفتن":"القول","گم شدن":"الضياع","گم کردن":"الإضاعة","گوش دادن":"الاستماع","مردن":"الموت","نشستن":"الجلوس","نگاه کردن":"النظر","نوشتن":"الكتابة","یاد دادن":"التعليم","یاد گرفتن":"التعلم","انتخاب کردن":"الاختيار","احساس کردن":"الإحساس","استفاده کردن":"الاستخدام"};
        const sentenceTemplates = { "آفریدن": { phrase: "جهان را", ar_phrase: "العالم", ar_verb: { past: ["خلقتُ","خلقتَ","خلق","خلقنا","خلقتم","خلقوا"], present: ["أخلقُ","تخلقُ","يخلقُ","نخلقُ","تخلقون","يخلقون"] } }, "آمدن": { phrase: "به خانه", ar_phrase: "إلى البيت", ar_verb: { past: ["أتيتُ","أتيتَ","أتى","أتينا","أتيتم","أتوا"], present: ["آتي","تأتي","يأتي","نأتي","تأتون","يأتون"] } }, "آوردن": { phrase: "یک هدیه را", ar_phrase: "هدية", ar_verb: { past: ["أحضرتُ","أحضرتَ","أحضر","أحضرنا","أحضرتم","أحضروا"], present: ["أُحضرُ","تُحضرُ","يُحضرُ","نُحضرُ","تُحضرون","يُحضرون"] } }, "انداختن": { phrase: "توپ را در سبد", ar_phrase: "الكرة في السلة", ar_verb: { past: ["رميتُ","رميتَ","رمى","رمينا","رميتم","رموا"], present: ["أرمي","ترمي","يرمي","نرمي","ترمُون","يرمون"] } }, "احساس کردن": { phrase: "خستگی", ar_phrase: "التعب", ar_verb: { past: ["أحسستُ","أحسستَ","أحس","أحسسنا","أحسستم","أحسوا"], present: ["أحسُ","تحسُ","يحسُ","نحسُ","تتحسون","يحسون"] } }, "استفاده کردن": { phrase: "از فرصت", ar_phrase: "من الفرصة", ar_verb: { past: ["استخدمتُ","استخدمتَ","استخدم","استخدمنا","استخدمتم","استخدموا"], present: ["أستخدمُ","تستخدمُ","يستخدمُ","نستخدمُ","تستخدمون","يستخدمون"] } }, "انتخاب کردن": { phrase: "بهترین گزینه را", ar_phrase: "الخيار الأفضل", ar_verb: { past: ["اخترتُ","اخترتَ","اختار","اخترنا","اخترتم","اختاروا"], present: ["أختارُ","تختارُ","يختارُ","نختارُ","تختارون","يختارون"] } }, "ایستادن": { phrase: "در صف", ar_phrase: "في الطابور", ar_verb: { past: ["وقفتُ","وقفتَ","وقف","وقفنا","وقفتم","وقفوا"], present: ["أقفُ","تقفُ","يقفُ","نقفُ","تقفون","يقفون"] } }, "باز کردن": { phrase: "در را", ar_phrase: "الباب", ar_verb: { past: ["فتحتُ","فتحتَ","فتح","فتحنا","فتحتم","فتحوا"], present: ["أفتحُ","تفتحُ","يفتحُ","نفتحُ","تفتحون","يفتحون"] } }, "بازی کردن": { phrase: "فوتبال", ar_phrase: "كرة القدم", ar_verb: { past: ["لعبتُ","لعبتَ","لعب","لعبنا","لعبتم","لعبوا"], present: ["ألعبُ","تلعبُ","يلعبُ","نلعبُ","تلعبون","يلعبون"] } }, "باور کردن": { phrase: "حرف او را", ar_phrase: "كلامه", ar_verb: { past: ["صدقتُ","صدقتَ","صدق","صدقنا","صدقتم","صدقوا"], present: ["أصدقُ","تصدقُ","يصدقُ","نصدقُ","تصدقون","يصدقون"] } }, "بخشیدن": { phrase: "خطای او را", ar_phrase: "خطأه", ar_verb: { past: ["سامحتُ","سامحتَ","سامح","سامحنا","سامحتم","سامحوا"], present: ["أسامحُ","تسامحُ","يسامحُ","نسامحُ","تسامحون","يسامحون"] } }, "بردن": { phrase: "کتاب را", ar_phrase: "الكتاب", ar_verb: { past: ["أخذتُ","أخذتَ","أخذ","أخذنا","أخذتم","أخذوا"], present: ["آخذُ","تأخذُ","يأخذُ","نأخذُ","تأخذون","يأخذون"] } }, "بستن": { phrase: "پنجره را", ar_phrase: "النافذة", ar_verb: { past: ["أغلقتُ","أغلقتَ","أغلق","أغلقنا","أغلقتم","أغلقوا"], present: ["أُغلقُ","تُغلقُ","يُغلقُ","نُغلقُ","تُغلقون","يُغلقون"] } }, "بلند کردن": { phrase: "جعبه را", ar_phrase: "الصندوق", ar_verb: { past: ["رفعتُ","رفعتَ","رفع","رفعنا","رفعتم","رفعوا"], present: ["أرفعُ","ترفعُ","يرفعُ","نرفعُ","ترفعون","يرفعون"] } }, "به یاد آوردن": { phrase: "خاطرات را", ar_phrase: "الذكريات", ar_verb: { past: ["تذكرتُ","تذكرتَ","تذكر","تذكرنا","تذكرتم","تذكروا"], present: ["أتذكرُ","تتذكرُ","يتذكرُ","نتذكرُ","تتذكرون","يتذكرون"] } }, "بودن": { phrase: "در کلاس", ar_phrase: "في الصف", ar_verb: { past: ["كنتُ","كنتَ","كان","كنا","كنتم","كانوا"], present: ["أكونُ","تكونُ","يكونُ","نكونُ","تكونون","يكونون"] } }, "پذیرفتن": { phrase: "دعوت را", ar_phrase: "الدعوة", ar_verb: { past: ["قبلتُ","قبلتَ","قبل","قبلنا","قبلتم","قبلوا"], present: ["أقبلُ","تقبلُ","يقبلُ","نقبلُ","تقبلون","يقبلون"] } }, "پریدن": { phrase: "از روی مانع", ar_phrase: "من فوق الحاجز", ar_verb: { past: ["قفزتُ","قفزتَ","قفز","قفزنا","قفزتم","قفزوا"], present: ["أقفزُ","تقفزُ","يقفزُ","نقفزُ","تقفزون","يقفزون"] } }, "پرسیدن": { phrase: "یک سوال را", ar_phrase: "سؤالاً", ar_verb: { past: ["سألتُ","سألتَ","سأل","سألنا","سألتم","سألوا"], present: ["أسألُ","تسألُ","يسألُ","نسألُ","تسألون","يسألون"] } }, "پیدا کردن": { phrase: "کلیدهایش را", ar_phrase: "مفاتيحه", ar_verb: { past: ["وجدتُ","وجدتَ","وجد","وجدنا","وجدتم","وجدوا"], present: ["أجدُ","تجدُ","يجدُ","نجدُ","تجدون","يجدون"] } }, "پوشیدن": { phrase: "لباس جدید را", ar_phrase: "الثوب الجديد", ar_verb: { past: ["لبستُ","لبستَ","لبس","لبسنا","لبستم","لبسوا"], present: ["ألبسُ","تلبسُ","يلبسُ","نلبسُ","تلبسون","يلبسون"] } }, "ترسیدن": { phrase: "از تاریکی", ar_phrase: "من الظلام", ar_verb: { past: ["خفتُ","خفتَ","خاف","خفنا","خفتم","خافوا"], present: ["أخافُ","تخافُ","يخافُ","نخافُ","تخافون","يخافون"] } }, "تنظیم کردن": { phrase: "ساعت را", ar_phrase: "الساعة", ar_verb: { past: ["نظمتُ","نظمتَ","نظم","نظمنا","نظمتم","نظموا"], present: ["أنظمُ","تنظمُ","ينظمُ","ننظمُ","تنظمون","ينظمون"] } }, "توانستن": { phrase: "این کار را انجام دهد", ar_phrase: "أن يفعل هذا الأمر", ar_verb: { past: ["استطعتُ","استطعتَ","استطاع","استطعنا","استطعتم","استطاعوا"], present: ["أستطيعُ","تستطيعُ","يستطيعُ","نستطيعُ","تستطيعون","يستطيعون"] } }, "توضیح دادن": { phrase: "درس را", ar_phrase: "الدرس", ar_verb: { past: ["شرحتُ","شرحتَ","شرح","شرحنا","شرحتم","شرحوا"], present: ["أشرحُ","تشرحُ","يشرحُ","نشرحُ","تشرحون","يشرحون"] } }, "جنگیدن": { phrase: "برای آزادی", ar_phrase: "من أجل الحرية", ar_verb: { past: ["قاتلتُ","قاتلتَ","قاتل","قاتلنا","قاتلتم","قاتلوا"], present: ["أقاتلُ","تقاتلُ","يقاتلُ","نقاتلُ","تقاتلون","يقاتلون"] } }, "حرکت کردن": { phrase: "به سمت جلو", ar_phrase: "نحو الأمام", ar_verb: { past: ["تحركتُ","تحركتَ","تحرك","تحركنا","تحركتم","تحركوا"], present: ["أتحركُ","تتحركُ","يتحركُ","نتحركُ","تتحركون","يتحركون"] } }, "خواستن": { phrase: "یک لیوان آب", ar_phrase: "كوب ماء", ar_verb: { past: ["أردتُ","أردتَ","أراد","أردنا","أردتم","أرادوا"], present: ["أريدُ","تريدُ","يريدُ","نريدُ","تريدون","يريدون"] } }, "خواندن": { phrase: "کتاب را", ar_phrase: "الكتاب", ar_verb: { past: ["قرأتُ","قرأتَ","قرأ","قرأنا","قرأتم","قرأوا"], present: ["أقرأُ","تقرأُ","يقرأُ","نقرأُ","تقرأون","يقرأون"] } }, "خریدن": { phrase: "میوه", ar_phrase: "فاكهة", ar_verb: { past: ["اشتريتُ","اشتريتَ","اشترى","اشترينا","اشتريتم","اشتروا"], present: ["أشتري","تشتري","يشتري","نشتري","تشترون","يشترون"] } }, "خندیدن": { phrase: "با صدای بلند", ar_phrase: "بصوت عالٍ", ar_verb: { past: ["ضحكتُ","ضحكتَ","ضحك","ضحكنا","ضحكتم","ضحكوا"], present: ["أضحكُ","تضحكُ","يضحكُ","نضحكُ","تضحكون","يضحكون"] } }, "خوابیدن": { phrase: "زود", ar_phrase: "مبكراً", ar_verb: { past: ["نمتُ","نمتَ","نام","نمنا","نمتم","ناموا"], present: ["أنامُ","تنامُ","ينامُ","ننامُ","تنامون","ينامون"] } }, "خوردن": { phrase: "شام را", ar_phrase: "العشاء", ar_verb: { past: ["أكلتُ","أكلتَ","أكل","أكلنا","أكلتم","أكلوا"], present: ["آكلُ","تأكلُ","يأكلُ","نأكلُ","تأكلون","يأكلون"] } }, "دادن": { phrase: "گل به مادر", ar_phrase: "وردة للأم", ar_verb: { past: ["أعطيتُ", "أعطيتَ", "أعطى", "أعطينا", "أعطيتم", "أعطوا"], present: ["أعطي", "تعطي", "يعطي", "نعطي", "تعطون", "يعطون"] } }, "داشتن": { phrase: "یک ماشین خوب", ar_phrase: "سيارة جيدة", ar_verb: { past: ["كان لديّ", "كان لديكَ", "كان لديه", "كان لدينا", "كان لديكم", "كان لديهم"], present: ["لديّ", "لديكَ", "لديه", "لدينا", "لديكم", "لديهم"] } }, "دانستن": { phrase: "جواب را", ar_phrase: "الإجابة", ar_verb: { past: ["عرفتُ","رفتَ","رف","رفنا","رفتم","رفوا"], present: ["أعرفُ","تعرفُ","يعرفُ","نعرفُ","تعرفون","يعرفون"] } }, "دنبال کردن": { phrase: "اهداف خود را", ar_phrase: "أهدافه", ar_verb: { past: ["تابعتُ","تابعتَ","تابع","تابعنا","تابعتم","تابعوا"], present: ["أتابعُ","تتابعُ","يتابعُ","نتابعُ","تتابعون","يتابعون"] } }, "دویدن": { phrase: "در پارک", ar_phrase: "في الحديقة", ar_verb: { past: ["ركضتُ","ركضتَ","ركض","ركضنا","ركضتم","ركضوا"], present: ["أركضُ","تركضُ","يركضُ","نركضُ","تركضون","يركضون"] } }, "دیدن": { phrase: "یک دوست قدیمی را", ar_phrase: "صديقاً قديماً", ar_verb: { past: ["رأيتُ","رأيتَ","رأى","رأينا","رأيتم","رأوا"], present: ["أرى","ترى","يرى","نرى","ترون","يرون"] } }, "راه رفتن": { phrase: "در خیابان", ar_phrase: "في الشارع", ar_verb: { past: ["مشيتُ","مشيتَ","مشى","مشينا","مشيتم","مشوا"], present: ["أمشي","تمشي","يمشي","نمشي","تمشون","يمشون"] } }, "زنگ زدن": { phrase: "به دوستش", ar_phrase: "بصديقه", ar_verb: { past: ["اتصلتُ","اتصلتَ","اتصل","اتصلنا","اتصلتم","اتصلوا"], present: ["أتصلُ","تتصلُ","يتصلُ","نتصلُ","تتصلون","يتصلون"] } }, "زندگی کردن": { phrase: "در آرامش", ar_phrase: "في سلام", ar_verb: { past: ["عشتُ","عشتَ","عاش","عشنا","عشتم","عاشوا"], present: ["أعيشُ","تعيشُ","يعيشُ","نعيشُ","تعيشون","يعيشون"] } }, "ساختن": { phrase: "یک مدل هواپیما", ar_phrase: "نموذج طائرة", ar_verb: { past: ["صنعتُ","صنعتَ","صنع","صنعنا","صنعتم","صنعوا"], present: ["أصنعُ","تصنعُ","يصنعُ","نصنعُ","تصنعون","يصنعون"] } }, "سعی کردن": { phrase: "برای موفقیت", ar_phrase: "للنجاح", ar_verb: { past: ["حاولتُ","حاولتَ","حاول","حاولنا","حاولتم","حاولوا"], present: ["أحاولُ","تحاولُ","يحاولُ","نحاولُ","تحاولون","يحاولون"] } }, "سفر کردن": { phrase: "به شمال", ar_phrase: "إلى الشمال", ar_verb: { past: ["سافرتُ","سافرتَ","سافر","سافرنا","سافرتم","سافروا"], present: ["أسافرُ","تسافرُ","يسافرُ","نسافرُ","تسافرون","يسافرون"] } }, "شناختن": { phrase: "یک دوست خوب را", ar_phrase: "صديقاً جيداً", ar_verb: { past: ["عرفتُ","عرفتَ","عرف","عرفنا","عرفتم","عرفوا"], present: ["أعرفُ","تعرفُ","يعرفُ","نعرفُ","تعرفون","يعرفون"] } }, "شنیدن": { phrase: "یک خبر خوب", ar_phrase: "خبراً جيداً", ar_verb: { past: ["سمعتُ","سمعتَ","سمع","سمعنا","سمعتم","سمعوا"], present: ["أسمعُ","تسمعُ","يسمعُ","نسمعُ","تسمعون","يسمعون"] } }, "شدن": { phrase: "پزشک", ar_phrase: "طبيباً", ar_verb: { past: ["أصبحتُ","أصبحتَ","أصبح","أصبحنا","أصبحتم","أصبحوا"], present: ["أُصبحُ","تُصبحُ","يُصبحُ","نُصبحُ","تُصبحون","يُصبحون"] } }, "شروع کردن": { phrase: "پروژه را", ar_phrase: "المشروع", ar_verb: { past: ["بدأتُ","بدأتَ","بدأ","بدأنا","بدأتم","بدأوا"], present: ["أبدأُ","تبدأُ","يبدأُ","نبدأُ","تبدأون","يبدأون"] } }, "شکستن": { phrase: "یک رکورد را", ar_phrase: "رقماً قياسياً", ar_verb: { past: ["كسرتُ","كسرتَ","كسر","كسرنا","كسرتم","كسروا"], present: ["أكسرُ","تكسرُ","يكسرُ","نكسرُ","تكسرون","يكسرون"] } }, "فروختن": { phrase: "خانه خود را", ar_phrase: "بيته", ar_verb: { past: ["بعتُ","بعتَ","باع","بعنا","بعتم","باعوا"], present: ["أبيعُ","تبيعُ","يبيعُ","نبيعُ","تبيعون","يبيعون"] } }, "فکر کردن": { phrase: "به یک راه حل", ar_phrase: "في حل", ar_verb: { past: ["فكرتُ", "فكرتَ", "فكر", "فكرنا", "فكرتم", "فكروا"], present: ["أفكرُ", "تفكرُ", "يفكرُ", "نفكرُ", "تفكرون", "يفكرون"] } }, "فهمیدن": { phrase: "موضوع را", ar_phrase: "الموضوع", ar_verb: { past: ["فهمتُ","فهمتَ","فهم","فهمنا","فهمتم","فهموا"], present: ["أفهمُ","تفهمُ","يفهمُ","نفهمُ","تفهمون","يفهمون"] } }, "کار کردن": { phrase: "با کامپیوتر", ar_phrase: "بالحاسوب", ar_verb: { past: ["عملتُ", "عملتَ", "عمل", "عملنا", "عملتم", "عملوا"], present: ["أعملُ", "تعملُ", "يعملُ", "نعملُ", "تعملون", "يعملون"] } }, "کمک کردن": { phrase: "به یک سالمند", ar_phrase: "مسناً", ar_verb: { past: ["ساعدتُ","ساعدتَ","ساعد","ساعدنا","ساعدتم","ساعدوا"], present: ["أساعدُ","تساعدُ","يساعدُ","نساعدُ","تساعدون","يساعدون"] } }, "گذاشتن": { phrase: "کلید را روی میز", ar_phrase: "المفتاح على الطاولة", ar_verb: { past: ["وضعتُ", "وضعتَ", "وضع", "وضعنا", "وضعتم", "وضعوا"], present: ["أضعُ", "تضعُ", "يضعُ", "نضعُ", "تضعون", "يضعون"] } }, "گرفتن": { phrase: "یک تاکسی", ar_phrase: "سيارة أجرة", ar_verb: { past: ["أخذتُ", "أخذتَ", "أخذ", "أخذنا", "أخذتم", "أخذوا"], present: ["آخذُ", "تأخذُ", "يأخذُ", "نأخذُ", "تأخذون", "يأخذون"] } }, "گفتن": { phrase: "حقیقت را", ar_phrase: "الحقيقة", ar_verb: { past: ["قلتُ","قلتَ","قال","قلنا","قلتم","قالوا"], present: ["أقولُ","تقولُ","يقولُ","نقولُ","تقولون","يقولون"] } }, "گم کردن": { phrase: "کیف پول را", ar_phrase: "المحفظة", ar_verb: { past: ["أضعتُ", "أضعتَ", "أضاع", "أضعنا", "أضعتم", "أضاعوا"], present: ["أُضيعُ", "تُضيعُ", "يُضيعُ", "نُضيعُ", "تُضيعون", "يُضيعون"] } }, "گوش دادن": { phrase: "به موسیقی", ar_phrase: "للموسيقى", ar_verb: { past: ["استمعتُ", "استمعتَ", "استمع", "استمعنا", "استمعتم", "استمعوا"], present: ["أستمعُ", "تستمعُ", "يستمعُ", "نستمعُ", "تستمعون", "يستمعون"] } }, "نشستن": { phrase: "روی مبل", ar_phrase: "على الأريكة", ar_verb: { past: ["جلستُ", "جلستَ", "جلس", "جلسنا", "جلستم", "جلسوا"], present: ["أجلسُ", "تجلسُ", "يجلسُ", "نجلسُ", "تجلسون", "يجلسون"] } }, "نگاه کردن": { phrase: "به عکس‌ها", ar_phrase: "إلى الصور", ar_verb: { past: ["نظرتُ", "نظرتَ", "نظر", "نظرنا", "نظرتم", "نظروا"], present: ["أنظرُ", "تنظرُ", "ينظرُ", "ننظرُ", "تنظرون", "ينظرون"] } }, "یاد گرفتن": { phrase: "یک مهارت جدید", ar_phrase: "مهارة جديدة", ar_verb: { past: ["تعلمتُ", "تعلمتَ", "تعلم", "تعلمنا", "تعلمتم", "تعلموا"], present: ["أتعلمُ", "تتعلمُ", "يتعلمُ", "نتعلمُ", "تتعلمون", "يتعلمون"] } }, "یاد دادن": { phrase: "شنا به کودکان", ar_phrase: "السباحة للأطفال", ar_verb: { past: ["علمتُ", "علمتَ", "علم", "علمنا", "علمتم", "علموا"], present: ["أُعلمُ", "تُعلمُ", "يُعلمُ", "نُعلمُ", "تُعلمون", "يُعلمون"] } }, "default": { phrase: "کاری را", ar_phrase: "عملاً ما", ar_verb: null } };

        // --- LOGIC ---
        let lastConjugationData = {};
        const elements = {};
        const elementIds = ['verb-select', 'verb-input', 'conjugate-btn', 'btn-text', 'conjugation-table', 'table-body', 'verb-info', 'examples-section', 'present-examples-btn', 'past-examples-btn', 'sentences-container', 'correction-notice', 'error-notice', 'results-container'];
        elementIds.forEach(id => { elements[id.replace(/-(\w)/g, (_, p1) => p1.toUpperCase())] = document.getElementById(id); });
        
        function toggleLoading(isLoading) {
            elements.conjugateBtn.querySelector('.loader').style.display = isLoading ? 'inline-block' : 'none';
            elements.btnText.textContent = isLoading ? 'جارِ التصريف...' : 'صَرّف الفعل';
            elements.conjugateBtn.disabled = isLoading;
        }

        function showResults(show) {
            if (show) {
                elements.errorNotice.style.display = 'none';
                elements.resultsContainer.classList.add('visible-results');
                elements.resultsContainer.classList.remove('hidden-results');
            } else {
                elements.resultsContainer.classList.remove('visible-results');
                elements.resultsContainer.classList.add('hidden-results');
            }
        }

        function showError(message) {
            elements.errorNotice.innerHTML = message;
            elements.errorNotice.style.display = 'block';
            showResults(false);
        }

        function levenshtein(a,b){if(a.length==0)return b.length;if(b.length==0)return a.length;const m=Array(b.length+1).fill(null).map(()=>Array(a.length+1).fill(null));for(let i=0;i<=a.length;i++){m[0][i]=i}for(let j=0;j<=b.length;j++){m[j][0]=j}for(let j=1;j<=b.length;j++){for(let i=1;i<=a.length;i++){const c=a[i-1]===b[j-1]?0:1;m[j][i]=Math.min(m[j][i-1]+1,m[j-1][i]+1,m[j-1][i-1]+c)}}return m[b.length][a.length]}
        function autoCorrect(verb){const allKnownVerbs=[...Object.keys(verbStems)];if(allKnownVerbs.includes(verb))return{correctedVerb:verb,wasCorrected:false};let bestMatch=null,minDistance=2;for(const knownVerb of allKnownVerbs){const distance=levenshtein(verb,knownVerb);if(distance<minDistance){minDistance=distance;bestMatch=knownVerb}}return{correctedVerb:bestMatch||verb,wasCorrected:!!bestMatch}}
        
        // ** دالة جديدة لتحويل الحروف **
        function normalizePersianChars(text) {
            if (!text) return "";
            return text.replace(/ي/g, 'ی').replace(/ك/g, 'ک');
        }

        // ** محرك الاشتقاق الجديد والمطوّر **
        function deriveStems(verbPart) {
            if (!verbPart || !verbPart.endsWith('ن')) return null;

            const pastStem = verbPart.slice(0, -1);
            let presentStem = null;

            // تطبيق القواعد من الأكثر تحديداً إلى الأكثر عمومية
            if (verbPart.endsWith('اختن')) { presentStem = pastStem.slice(0, -2) + 'از'; }       // شناختن -> شناس
            else if (verbPart.endsWith('اشتن')) { presentStem = pastStem.slice(0, -2) + 'ار'; }   // داشتن -> دار
            else if (verbPart.endsWith('افتن')) { presentStem = pastStem.slice(0, -2) + 'اب'; }    // یافتن -> یاب
            else if (verbPart.endsWith('وختن')) { presentStem = pastStem.slice(0, -2) + 'وز'; }   // فروختن -> فروش (خطأ في النسخة القديمة) -> فروختن -> فروش
            else if (verbPart.endsWith('ودن')) {                                                // پیمودن -> پیما
                if (verbPart.endsWith('سودن')) { presentStem = pastStem.slice(0, -2) + 'ا'; }       // فرسودن -> فرسا
                else { presentStem = pastStem.slice(0, -2) + 'ای'; }
            }
            else if (verbPart.endsWith('ادن')) { presentStem = pastStem.slice(0, -1); }           // ایستادن -> ایست
            else if (verbPart.endsWith('ستن')) {
                 if (verbPart === 'شستن') { presentStem = 'شو'; }
                 else if (verbPart.endsWith('سستن')) { presentStem = pastStem.slice(0, -2) + 'ل'; } // گسستن -> گسل
                 else { presentStem = pastStem.slice(0, -1); }                                     // دانستن -> دان
            }
            else if (verbPart.endsWith('اندن')) { presentStem = pastStem.slice(0, -2) + 'ان'; }   // خواندن -> خوان
            else if (verbPart.endsWith('ردن')) {
                 if (pastStem.endsWith('کرد')) { presentStem = pastStem.slice(0, -2) + 'ن'; }      // کردن -> کن
                 else { presentStem = pastStem.slice(0, -2) + 'ر'; }                                // بردن -> بر
            }
            else if (verbPart.endsWith('فتن')) {
                 if (verbPart === 'رفتن') { presentStem = 'رو'; }
                 else if (verbPart === 'گرفتن') { presentStem = 'گیر'; }
                 else { presentStem = pastStem.slice(0, -2) + 'ب'; }                              // پذیرفتن -> پذیر
            }
            else if (verbPart.endsWith('شتن')) { presentStem = pastStem.slice(0, -2) + 'ر'; }    // گشتن -> گرد
            else if (verbPart.endsWith('یدن')) { presentStem = pastStem.slice(0, -2); }          // القاعدة العامة: ترسیدن -> ترس
            
            if (presentStem) { return { pastStem, presentStem }; }

            return null; // فشل الاشتقاق
        }

        function conjugate(infinitive) { 
            const finalInfinitive = infinitive.trim(); 
            if (!finalInfinitive) return false; 
            
            lastConjugationData = { infinitive: finalInfinitive };
            const isCompound = finalInfinitive.includes(' ');
            let nounPart = '', verbPart = finalInfinitive, pastStem, presentStem; 
            
            if (isCompound) { 
                const parts = finalInfinitive.split(' '); 
                nounPart = parts.slice(0, -1).join(' ') + ' '; 
                verbPart = parts[parts.length - 1]; 
            }
            
            let stemsFound = false; 
            if (verbStems[finalInfinitive]) { 
                pastStem = verbPart.slice(0, -1); 
                presentStem = verbStems[finalInfinitive].replace(nounPart, ''); 
                stemsFound = true; 
            } else { 
                const derived = deriveStems(verbPart); 
                if (derived) { 
                    pastStem = derived.pastStem; 
                    presentStem = derived.presentStem; 
                    stemsFound = true; 
                } 
            } 
            
            if (!stemsFound) { 
                showError(`الفعل <strong class="persian-text">"${finalInfinitive}"</strong> شاذ جداً أو غير صحيح. لم يتمكن المحرك الذكي من اشتقاقه.`);
                return false; 
            } 
            
            const fullPastStem = nounPart + pastStem, fullPresentStem = nounPart + presentStem; 
            elements.verbInfo.innerHTML = `<span class="persian-text">المصدر: <span class="fw-bold">${finalInfinitive}</span></span> | <span class="persian-text">الماضي: <span class="fw-bold">${fullPastStem}</span></span> | <span class="persian-text">المضارع: <span class="fw-bold">${fullPresentStem}</span></span>`; 
            elements.verbInfo.style.display = 'block'; 
            
            const pastEndings = ['م', 'ی', '', 'یم', 'ید', 'ند'], presentEndings = ['م', 'ی', 'د', 'یم', 'ید', 'ند']; 
            lastConjugationData.past = pastEndings.map(e => nounPart + pastStem + e); 
            lastConjugationData.present = presentEndings.map(e => (nounPart ? nounPart + 'می‌' : 'می‌') + presentStem + e); 
            lastConjugationData.imperative = generateImperative(verbPart, presentStem, nounPart, isCompound); 
            
            displayTable(lastConjugationData); 
            return true; 
        }

        function generateImperative(verbPart, presentStem, nounPart, isCompound) { let s, p; if (verbPart === 'داشتن') { s = 'داشته باش'; p = 'داشته باشید'; } else if (verbPart === 'بودن') { s = 'باش'; p = 'باشید'; } else if (verbPart === 'آمدن') { s = 'بیا'; p = 'بیایید'; } else { s = (isCompound || presentStem.startsWith('آ')) ? presentStem : `ب${presentStem}`; p = (isCompound || presentStem.startsWith('آ')) ? presentStem + 'ید' : `ب${presentStem}ید`; } return ['', nounPart + s, '', '', nounPart + p, '']; }
        function displayTable(data) { elements.tableBody.innerHTML = ''; pronouns.forEach((p, i) => { const row = document.createElement('tr'); row.innerHTML = `<td class="pronoun-col">${p.fa}<br><small>(${p.ar})</small></td><td>${data.past[i]}</td><td>${data.present[i]}</td><td>${data.imperative[i] || '—'}</td>`; elements.tableBody.appendChild(row); }); showResults(true); }
        function generateSentences(tense) { const template = sentenceTemplates[lastConjugationData.infinitive] || sentenceTemplates.default; const verbs = lastConjugationData[tense]; let sentencesHTML = '<ul>'; pronouns.forEach((p, i) => { const persianSentence = `${p.fa} ${template.phrase} ${verbs[i]}`; let arabicTranslation; if (template.ar_verb && template.ar_verb[tense]) { const arabicVerb = template.ar_verb[tense][i]; arabicTranslation = `${p.ar} ${arabicVerb} ${template.ar_phrase}`; } else { arabicTranslation = `${p.ar} ... ${template.ar_phrase || ''}`; } sentencesHTML += `<li><span class="persian-text">${persianSentence.trim()}.</span> <span class="arabic-translation">(${arabicTranslation.trim()})</span></li>`; }); sentencesHTML += '</ul>'; elements.sentencesContainer.innerHTML = sentencesHTML; elements.sentencesContainer.style.display = 'block'; }
        
        function handleRequest(source) {
            let verb = source.value;
            verb = normalizePersianChars(verb).trim();
            if (!verb) return;

            toggleLoading(true);

            setTimeout(() => {
                const { correctedVerb, wasCorrected } = autoCorrect(verb);
                if (wasCorrected) {
                    elements.correctionNotice.innerHTML = `هل تقصد <strong class="persian-text">"${correctedVerb}"</strong>؟ تم التصحيح تلقائيًا.`;
                    elements.correctionNotice.style.display = 'block';
                    verb = correctedVerb;
                    source.value = verb;
                } else {
                    elements.correctionNotice.style.display = 'none';
                }

                if (source.id === 'verb-input') { elements.verbSelect.value = ''; } else { elements.verbInput.value = ''; }
                
                if (!conjugate(verb)) {
                    // showError handles UI
                }
                
                toggleLoading(false);
            }, 50);
        }

        // --- INIT & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            const allVerbs = Object.keys(verbStems).sort((a, b) => a.localeCompare(b, 'fa'));
            let optionsHtml = '<option value="">-- اختر فعلاً من القائمة --</option>';
            allVerbs.forEach(verb => { const meaning = verbMeanings[verb] || ''; optionsHtml += `<option value="${verb}">${verb} (${meaning})</option>`; });
            elements.verbSelect.innerHTML = optionsHtml;
            
            elements.verbSelect.addEventListener('change', () => handleRequest(elements.verbSelect));
            elements.conjugateBtn.addEventListener('click', () => handleRequest(elements.verbInput));
            
            // ** معالجة فورية للحروف عند الكتابة **
            elements.verbInput.addEventListener('input', () => {
                const originalValue = elements.verbInput.value;
                const normalizedValue = normalizePersianChars(originalValue);
                if (originalValue !== normalizedValue) {
                    const cursorPos = elements.verbInput.selectionStart;
                    elements.verbInput.value = normalizedValue;
                    elements.verbInput.setSelectionRange(cursorPos, cursorPos);
                }
            });

            elements.verbInput.addEventListener('keypress', (e) => { if (e.key === "Enter") { e.preventDefault(); handleRequest(elements.verbInput); } });
            elements.pastExamplesBtn.addEventListener('click', () => generateSentences('past'));
            elements.presentExamplesBtn.addEventListener('click', () => generateSentences('present'));
        });
    </script>
    </body>
</html>
