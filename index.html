<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>المُصرّف الخبير للأفعال الفارسية (مع الترجمة)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Vazirmatn:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --card-bg-color: rgba(255, 255, 255, 0.65);
            --primary-color: #4a6cf7;
            --primary-light: #eef2ff;
            --danger-color: #dc3545;
            --danger-light: #f8d7da;
            --text-dark: #1e293b;
            --text-light: #637381;
            --border-color: rgba(255, 255, 255, 0.25);
            --shadow-color: rgba(74, 108, 247, 0.15);
        }

        @keyframes animated-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        *, *::before, *::after {
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html { height: 100%; overflow: hidden; }

        body {
            display: flex;
            flex-direction: column;
            height: 100%;
            margin: 0;
            font-family: 'Cairo', 'Tahoma', sans-serif;
            font-weight: 400;
            color: var(--text-dark);
            background: linear-gradient(-45deg, #eef2f7, #e0eaff, #d1ecf1, #c5f0e9);
            background-size: 400% 400%;
            animation: animated-gradient 15s ease infinite;
        }

        .persian-text { font-family: 'Vazirmatn', sans-serif; font-weight: 400; }
        .fw-bold { font-weight: 700 !important; }

        .fixed-header, .fixed-footer {
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 10;
            border-bottom: 1px solid var(--border-color);
        }
        .fixed-header h1 {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            margin: 12px 0;
        }
        .fixed-footer { border-bottom: none; border-top: 1px solid var(--border-color); }
        .fixed-footer p { text-align: center; margin: 15px 0; color: var(--text-light); font-size: 14px; }

        #scroll-wrapper { flex-grow: 1; overflow-y: auto; padding: 25px 15px; }

        #main-container {
            background: var(--card-bg-color);
            padding: 30px 35px;
            border-radius: 24px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 10px 40px var(--shadow-color);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            transition: all 0.3s ease;
        }

        h2 {
            font-size: 20px;
            font-weight: 600;
            margin: 25px 0 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            color: var(--text-dark);
        }
        h2:first-of-type { margin-top: 0; }
        
        #verb-select, #verb-input {
            width: 100%;
            padding: 14px 18px;
            font-size: 17px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.1);
            background-color: rgba(255, 255, 255, 0.8);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #verb-select:focus, #verb-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
            background-color: #fff;
        }
        #verb-input { direction: ltr; text-align: right; }

        #conjugate-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 16px;
            margin-top: 15px;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            background: linear-gradient(45deg, var(--primary-color), #6a82fb);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #conjugate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(74, 108, 247, 0.3);
        }
        #conjugate-btn:active { transform: translateY(0); }
        #conjugate-btn .loader {
            width: 18px; height: 18px;
            border: 2px solid #fff;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: none;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #results-container {
            margin-top: 25px;
            transition: all 0.5s ease;
        }
        .hidden-results {
            opacity: 0;
            transform: translateY(20px);
            max-height: 0;
            overflow: hidden;
        }
        .visible-results {
            opacity: 1;
            transform: translateY(0);
            max-height: 1500px; /* A large enough value */
        }
        
        .notification {
            text-align: center;
            margin-bottom: 20px;
            padding: 14px;
            border-radius: 10px;
            display: none;
        }
        #correction-notice { background-color: var(--primary-light); color: var(--primary-color); border: 1px solid var(--primary-color); }
        #verb-info { background-color: #f8f9fa; border: 1px solid rgba(0,0,0,0.1); font-size: 15px; }
        #error-notice { background-color: var(--danger-light); color: var(--danger-color); border: 1px solid var(--danger-color); }
        
        .table-responsive { width: 100%; overflow-x: auto; border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; }
        #conjugation-table {
            width: 100%;
            border-collapse: collapse;
        }
        #conjugation-table th, #conjugation-table td {
            border: none;
            padding: 14px;
            text-align: center;
            font-size: 16px;
            vertical-align: middle;
        }
        #conjugation-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        #conjugation-table tbody tr:nth-child(even) { background-color: rgba(238, 242, 255, 0.7); }
        #conjugation-table tbody tr:hover { background-color: rgba(226, 232, 240, 0.8); }
        #conjugation-table td.pronoun-col { font-weight: 600; color: var(--text-dark); }
        #conjugation-table td small { color: var(--text-light); font-size: 12px; }

        #examples-section { margin-top: 30px; padding-top: 25px; border-top: 1px dashed rgba(0,0,0,0.1); }
        #example-options { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        #example-options button {
            background: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 10px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        #example-options button:hover { background-color: var(--primary-color); color: #fff; }

        #sentences-container {
            margin-top: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 12px;
            display: none;
        }
        #sentences-container ul { list-style-type: none; padding: 0; margin: 0; }
        #sentences-container li { font-size: 17px; padding: 12px 0; border-bottom: 1px solid #e9ecef; }
        #sentences-container li:last-child { border-bottom: none; }
        .arabic-translation { color: var(--text-light); font-size: 14px; margin-right: 10px;}

        @media (max-width: 768px) {
            #scroll-wrapper { padding: 20px 10px; }
            .fixed-header h1 { font-size: 20px; }
            #main-container { padding: 20px 15px; }
            h2 { font-size: 18px; }
        }
    </style>
</head>
<body>
    <header class="fixed-header"><h1 class="persian-text">المُصرّف الخبير للأفعال الفارسية</h1></header>
    
    <div id="scroll-wrapper">
        <div id="main-container">
            <div id="controls-container">
                <h2 class="persian-text">۱. انتخاب از لیست</h2>
                <div class="input-section"><select id="verb-select" class="persian-text"></select></div>
                
                <h2 class="persian-text">۲. یا نوشتن مصدر فعل</h2>
                <div class="input-section">
                    <input type="text" id="verb-input" class="persian-text" placeholder="اكتب أي مصدر فعل... سيتم تصحيح الحروف تلقائياً">
                    <button id="conjugate-btn">
                        <span id="btn-text">صَرّف الفعل</span>
                        <div class="loader"></div>
                    </button>
                </div>
            </div>
            
            <div id="error-notice" class="notification"></div>
            <div id="results-container" class="hidden-results">
                <div id="correction-notice" class="notification"></div>
                <div id="verb-info" class="notification"></div>
                <div class="table-responsive"><table id="conjugation-table"><thead ><tr><th class="pronoun-col">الضمير</th><th class="persian-text">ماضی ساده</th><th class="persian-text">حال اخباری</th><th class="persian-text">امر</th></tr></thead><tbody id="table-body" class="persian-text"></tbody></table></div>
                <div id="examples-section">
                    <div id="example-options">
                        <button id="present-examples-btn" class="persian-text">جملات حال (مضارع)</button>
                        <button id="past-examples-btn" class="persian-text">جملات گذشته (ماضی)</button>
                    </div>
                    <div id="sentences-container"></div>
                </div>
            </div>
        </div>
    </div>

    <footer class="fixed-footer"><p>تم التطوير بواسطة احمد فلاح عريبي |  2025</p></footer>

    <script>
        // --- DATA ---
        const pronouns = [ { fa: "من", ar: "أنا" }, { fa: "تو", ar: "أنت" }, { fa: "او", ar: "هو/هي" }, { fa: "ما", ar: "نحن" }, { fa: "شما", ar: "أنتم" }, { fa: "آنها", ar: "هم" } ];
        
        // --- ** قاعدة البيانات الدلالية الجديدة والمدققة ** ---
        const verbData = {
            "آفریدن": { stem: "آفرین", category: "creation", object: { fa: "یک اثر هنری را", ar: "عملاً فنياً" }, ar_verb: { past: ["خلقتُ","خلقتَ","خلق","خلقنا","خلقتم","خلقوا"], present: ["أخلقُ","تخلقُ","يخلقُ","نخلقُ","تخلقون","يخلقون"] } },
            "آمدن": { stem: "آ", category: "motion", prep_phrase: { fa: "به مهمانی", ar: "إلى الحفلة" }, ar_verb: { past: ["أتيتُ","أتيتَ","أتى","أتينا","أتيتم","أتوا"], present: ["آتي","تأتي","يأتي","نأتي","تأتون","يأتون"] } },
            "آوردن": { stem: "آور", category: "motion_transitive", object: { fa: "خبرهای خوب را", ar: "أخباراً جيدة" }, ar_verb: { past: ["أحضرتُ","أحضرتَ","أحضر","أحضرنا","أحضرتم","أحضروا"], present: ["أُحضرُ","تُحضرُ","يُحضرُ","نُحضرُ","تُحضرون","يُحضرون"] } },
            "انداختن": { stem: "انداز", category: "motion_transitive", object: { fa: "نگاهی سریع", ar: "نظرة سريعة" }, ar_verb: { past: ["ألقيتُ","ألقيتَ","ألقى","ألقينا","ألقيتم","ألقوا"], present: ["أُلقي","تُلقي","يُلقي","نُلقي","تُلقون","يُلقون"] } },
            "ایستادن": { stem: "ایست", category: "state_intransitive", prep_phrase: { fa: "جلوی آینه", ar: "أمام المرآة" }, ar_verb: { past: ["وقفتُ","وقفتَ","وقف","وقفنا","وقفتم","وقفوا"], present: ["أقفُ","تقفُ","يقفُ","نقفُ","تقفون","يقفون"] } },
            "باز کردن": { stem: "باز کن", category: "action_transitive", object: { fa: "کتاب را", ar: "الكتاب" }, ar_verb: { past: ["فتحتُ","فتحتَ","فتح","فتحنا","فتحتم","فتحوا"], present: ["أفتحُ","تفتحُ","يفتحُ","نفتحُ","تفتحون","يفتحون"] } },
            "بازی کردن": { stem: "بازی کن", category: "action_transitive", object: { fa: "در پارک", ar: "في الحديقة" }, ar_verb: { past: ["لعبتُ","لعبتَ","لعب","لعبنا","لعبتم","لعبوا"], present: ["ألعبُ","تلعبُ","يلعبُ","نلعبُ","تلعبون","يلعبون"] } },
            "باور کردن": { stem: "باور کن", category: "cognition", object: { fa: "داستان او را", ar: "قصته" }, ar_verb: { past: ["صدقتُ","صدقتَ","صدق","صدقنا","صدقتم","صدقوا"], present: ["أصدقُ","تصدقُ","يصدقُ","نصدقُ","تصدقون","يصدقون"] } },
            "بخشیدن": { stem: "بخش", category: "social", object: { fa: "اشتباه دوستم را", ar: "خطأ صديقي" }, ar_verb: { past: ["سامحتُ","سامحتَ","سامح","سامحنا","سامحتم","سامحوا"], present: ["أسامحُ","تسامحُ","يسامحُ","نسامحُ","تسامحون","يسامحون"] } },
            "بردن": { stem: "بر", category: "motion_transitive", object: { fa: "جایزه اول را", ar: "بالجائزة الأولى" }, ar_verb: { past: ["فزتُ","فزتَ","فاز","فزنا","فزتم","فازوا"], present: ["أفوزُ","تفوزُ","يفوزُ","نفوزُ","تفوزون","يفوزون"] } },
            "بستن": { stem: "بند", category: "action_transitive", object: { fa: "در را", ar: "الباب" }, ar_verb: { past: ["أغلقتُ","أغلقتَ","أغلق","أغلقنا","أغلقتم","أغلقوا"], present: ["أُغلقُ","تُغلقُ","يُغلقُ","نُغلقُ","تُغلقون","يُغلقون"] } },
            "بلند کردن": { stem: "بلند کن", category: "action_transitive", object: { fa: "صدایم را", ar: "صوتي" }, ar_verb: { past: ["رفعتُ","رفعتَ","رفع","رفعنا","رفعتم","رفعوا"], present: ["أرفعُ","ترفعُ","يرفعُ","نرفعُ","ترفعون","يرفعون"] } },
            "به یاد آوردن": { stem: "به یاد آور", category: "cognition", object: { fa: "یک خاطره قدیمی را", ar: "ذكرى قديمة" }, ar_verb: { past: ["تذكرتُ","تذكرتَ","تذكر","تذكرنا","تذكرتم","تذكروا"], present: ["أتذكرُ","تتذكرُ","يتذكرُ","نتذكرُ","تتذكرون","يتذكرون"] } },
            "بودن": { stem: "باش", category: "state_linking", complement: { fa: "خوشحال", ar: "سعيداً" }, ar_verb: { past: ["كنتُ","كنتَ","كان","كنا","كنتم","كانوا"], present: ["أكونُ","تكونُ","يكونُ","نكونُ","تكونون","يكونون"] } },
            "پذیرفتن": { stem: "پذیر", category: "social", object: { fa: "یک مسئولیت جدید را", ar: "مسؤولية جديدة" }, ar_verb: { past: ["قبلتُ","قبلتَ","قبل","قبلنا","قبلتم","قبلوا"], present: ["أقبلُ","تقبلُ","يقبلُ","نقبلُ","تقبلون","يقبلون"] } },
            "پریدن": { stem: "پر", category: "motion_intransitive", prep_phrase: { fa: "از خوشحالی", ar: "من الفرح" }, ar_verb: { past: ["قفزتُ","قفزتَ","قفز","قفزنا","قفزتم","قفزوا"], present: ["أقفزُ","تقفزُ","يقفزُ","نقفزُ","تقفزون","يقفزون"] } },
            "پرسیدن": { stem: "پرس", category: "communication", object: { fa: "یک سوال مهم را", ar: "سؤالاً مهماً" }, ar_verb: { past: ["سألتُ","سألتَ","سأل","سألنا","سألتم","سألوا"], present: ["أسألُ","تسألُ","يسألُ","نسألُ","تسألون","يسألون"] } },
            "پیدا کردن": { stem: "پیدا کن", category: "cognition", object: { fa: "یک راه حل", ar: "حلاً" }, ar_verb: { past: ["وجدتُ","وجدتَ","وجد","وجدنا","وجدتم","وجدوا"], present: ["أجدُ","تجدُ","يجدُ","نجدُ","تجدون","يجدون"] } },
            "پوشیدن": { stem: "پوش", category: "action_transitive", object: { fa: "لباس رسمی را", ar: "الملابس الرسمية" }, ar_verb: { past: ["ارتديتُ","ارتديتَ","ارتدى","ارتدينا","ارتديتم","ارتدوا"], present: ["أرتدي","ترتدي","يرتدي","نرتدي","ترتدون","يرتدون"] } },
            "ترسیدن": { stem: "ترس", category: "emotion", prep_phrase: { fa: "از ارتفاع", ar: "من المرتفعات" }, ar_verb: { past: ["خفتُ","خفتَ","خاف","خفنا","خفتم","خافوا"], present: ["أخافُ","تخافُ","يخافُ","نخافُ","تخافون","يخافون"] } },
            "تنظیم کردن": { stem: "تنظیم کن", category: "action_transitive", object: { fa: "قرار ملاقات را", ar: "الموعد" }, ar_verb: { past: ["نظمتُ","نظمتَ","نظم","نظمنا","نظمتم","نظموا"], present: ["أنظمُ","تنظمُ","ينظمُ","ننظمُ","تنظمون","ينظمون"] } },
            "توانستن": { stem: "توان", category: "modal", infinitive_phrase: { fa: "مشکل را حل کند", ar: "أن يحل المشكلة" }, ar_verb: { past: ["استطعتُ","استطعتَ","استطاع","استطعنا","استطعتم","استطاعوا"], present: ["أستطيعُ","تستطيعُ","يستطيعُ","نستطيعُ","تستطيعون","يستطيعون"] } },
            "توضیح دادن": { stem: "توضیح ده", category: "communication", object: { fa: "ایده خود را", ar: "فكرته" }, ar_verb: { past: ["شرحتُ","شرحتَ","شرح","شرحنا","شرحتم","شرحوا"], present: ["أشرحُ","تشرحُ","يشرحُ","نشرحُ","تشرحون","يشرحون"] } },
            "جنگیدن": { stem: "جنگ", category: "social", prep_phrase: { fa: "با مشکلات", ar: "مع المشاكل" }, ar_verb: { past: ["صارعتُ","صارعتَ","صارع","صارعنا","صارعتم","صارعوا"], present: ["أصارعُ","تصارعُ","يصارعُ","نصارعُ","تصارعون","يصارعون"] } },
            "حرکت کردن": { stem: "حرکت کن", category: "motion_intransitive", prep_phrase: { fa: "به سوی هدف", ar: "نحو الهدف" }, ar_verb: { past: ["تحركتُ","تحركتَ","تحرك","تحركنا","تحركتم","تحركوا"], present: ["أتحركُ","تتحركُ","يتحركُ","نتحركُ","تتحركون","يتحركون"] } },
            "خواستن": { stem: "خواه", category: "cognition", object: { fa: "موفقیت", ar: "النجاح" }, ar_verb: { past: ["أردتُ","أردتَ","أراد","أردنا","أردتم","أرادوا"], present: ["أريدُ","تريدُ","يريدُ","نريدُ","تريدون","يريدون"] } },
            "خواندن": { stem: "خوان", category: "communication", object: { fa: "یک رمان", ar: "رواية" }, ar_verb: { past: ["قرأتُ","قرأتَ","قرأ","قرأنا","قرأتم","قرأوا"], present: ["أقرأُ","تقرأُ","يقرأُ","نقرأُ","تقرأون","يقرأون"] } },
            "خریدن": { stem: "خر", category: "transaction", object: { fa: "یک هدیه", ar: "هدية" }, ar_verb: { past: ["اشتريتُ","اشتريتَ","اشترى","اشترينا","اشتريتم","اشتروا"], present: ["أشتري","تشتري","يشتري","نشتري","تشترون","يشترون"] } },
            "خندیدن": { stem: "خند", category: "emotion", prep_phrase: { fa: "به یک جوک", ar: "على نكتة" }, ar_verb: { past: ["ضحكتُ","ضحكتَ","ضحك","ضحكنا","ضحكتم","ضحكوا"], present: ["أضحكُ","تضحكُ","يضحكُ","نضحكُ","تضحكون","يضحكون"] } },
            "خوابیدن": { stem: "خواب", category: "state_intransitive", prep_phrase: { fa: "روی تخت", ar: "على السرير" }, ar_verb: { past: ["نمتُ","نمتَ","نام","نمنا","نمتم","ناموا"], present: ["أنامُ","تنامُ","ينامُ","ننامُ","تنامون","ينامون"] } },
            "خوردن": { stem: "خور", category: "ingestion", object: { fa: "یک سیب", ar: "تفاحة" }, ar_verb: { past: ["أكلتُ","أكلتَ","أكل","أكلنا","أكلتم","أكلوا"], present: ["آكلُ","تأكلُ","يأكلُ","نأكلُ","تأكلون","يأكلون"] } },
            "دادن": { stem: "ده", category: "transaction", object: { fa: "یک کتاب به او", ar: "كتاباً له" }, ar_verb: { past: ["أعطيتُ", "أعطيتَ", "أعطى", "أعطينا", "أعطيتم", "أعطوا"], present: ["أعطي", "تعطي", "يعطي", "نعطي", "تعطون", "يعطون"] } },
            "داشتن": { stem: "دار", category: "possession", object: { fa: "یک ایده خوب", ar: "فكرة جيدة" }, ar_verb: { past: ["كان لديّ", "كان لديكَ", "كان لديه", "كان لدينا", "كان لديكم", "كان لديهم"], present: ["لديّ", "لديكَ", "لديه", "لدينا", "لديكم", "لديهم"] } },
            "دانستن": { stem: "دان", category: "cognition", object: { fa: "حقیقت را", ar: "الحقيقة" }, ar_verb: { past: ["عرفتُ","عرفتَ","عرف","عرفنا","عرفتم","عرفوا"], present: ["أعرفُ","تعرفُ","يعرفُ","نعرفُ","تعرفون","يعرفون"] } },
            "دنبال کردن": { stem: "دنبال کن", category: "action_transitive", object: { fa: "اخبار را", ar: "الأخبار" }, ar_verb: { past: ["تابعتُ","تابعتَ","تابع","تابعنا","تابعتم","تابعوا"], present: ["أتابعُ","تتابعُ","يتابعُ","نتابعُ","تتابعون","يتابعون"] } },
            "دویدن": { stem: "دو", category: "motion_intransitive", prep_phrase: { fa: "در مسابقه", ar: "في السباق" }, ar_verb: { past: ["ركضتُ","ركضتَ","ركض","ركضنا","ركضتم","ركضوا"], present: ["أركضُ","تركضُ","يركضُ","نركضُ","تركضون","يركضون"] } },
            "دیدن": { stem: "بین", category: "perception", object: { fa: "یک فیلم", ar: "فيلماً" }, ar_verb: { past: ["شاهدتُ","شاهدتَ","شاهد","شاهدنا","شاهدتم","شاهدوا"], present: ["أُشاهد","تُشاهد","يُشاهد","نُشاهد","تُشاهدون","يُشاهدون"] } },
            "راه رفتن": { stem: "راه رو", category: "motion_intransitive", prep_phrase: { fa: "در ساحل", ar: "على الشاطئ" }, ar_verb: { past: ["مشيتُ","مشيتَ","مشى","مشينا","مشيتم","مشوا"], present: ["أمشي","تمشي","يمشي","نمشي","تمشون","يمشون"] } },
            "رفتن": { stem: "رو", category: "motion_intransitive", prep_phrase: { fa: "به دانشگاه", ar: "إلى الجامعة" }, ar_verb: { past: ["ذهبتُ","ذهبتَ","ذهب","ذهبنا","ذهبتم","ذهبوا"], present: ["أذهبُ","تذهبُ","يذهبُ","نذهبُ","تذهبون","يذهبون"] } },
            "زنگ زدن": { stem: "زنگ زن", category: "communication", prep_phrase: { fa: "به خانواده", ar: "بالعائلة" }, ar_verb: { past: ["اتصلتُ","اتصلتَ","اتصل","اتصلنا","اتصلتم","اتصلوا"], present: ["أتصلُ","تتصلُ","يتصلُ","نتصلُ","تتصلون","يتصلون"] } },
            "زندگی کردن": { stem: "زندگی کن", category: "state_intransitive", prep_phrase: { fa: "در یک شهر بزرگ", ar: "في مدينة كبيرة" }, ar_verb: { past: ["عشتُ","عشتَ","عاش","عشنا","عشتم","عاشوا"], present: ["أعيشُ","تعيشُ","يعيشُ","نعيشُ","تعيشون","يعيشون"] } },
            "ساختن": { stem: "ساز", category: "creation", object: { fa: "یک خانه زیبا", ar: "بيتاً جميلاً" }, ar_verb: { past: ["بنيتُ","بنيتَ","بنى","بنينا","بنيتم","بنوا"], present: ["أبني","تبني","يبني","نبني","تبنون","يبنون"] } },
            "سعی کردن": { stem: "سعی کن", category: "action_intransitive", prep_phrase: { fa: "بهترین باشد", ar: "أن يكون الأفضل" }, ar_verb: { past: ["حاولتُ","حاولتَ","حاول","حاولنا","حاولتم","حاولوا"], present: ["أحاولُ","تحاولُ","يحاولُ","نحاولُ","تحاولون","يحاولون"] } },
            "سفر کردن": { stem: "سفر کن", category: "motion_intransitive", prep_phrase: { fa: "به یک کشور جدید", ar: "إلى بلد جديد" }, ar_verb: { past: ["سافرتُ","سافرتَ","سافر","سافرنا","سافرتم","سافروا"], present: ["أسافرُ","تسافرُ","يسافرُ","نسافرُ","تسافرون","يسافرون"] } },
            "شناختن": { stem: "شناس", category: "cognition", object: { fa: "دوستان واقعی را", ar: "الأصدقاء الحقيقيين" }, ar_verb: { past: ["عرفتُ","عرفتَ","عرف","عرفنا","عرفتم","عرفوا"], present: ["أعرفُ","تعرفُ","يعرفُ","نعرفُ","تعرفون","يعرفون"] } },
            "شنیدن": { stem: "شنو", category: "perception", object: { fa: "صدای موسیقی را", ar: "صوت الموسيقى" }, ar_verb: { past: ["سمعتُ","سمعتَ","سمع","سمعنا","سمعتم","سمعوا"], present: ["أسمعُ","تسمعُ","يسمعُ","نسمعُ","تسمعون","يسمعون"] } },
            "شدن": { stem: "شو", category: "change_of_state", complement: { fa: "یک معلم", ar: "معلماً" }, ar_verb: { past: ["أصبحتُ","أصبحتَ","أصبح","أصبحنا","أصبحتم","أصبحوا"], present: ["أُصبحُ","تُصبحُ","يُصبحُ","نُصبحُ","تُصبحون","يُصبحون"] } },
            "شروع کردن": { stem: "شروع کن", category: "action_transitive", object: { fa: "یک فصل جدید", ar: "فصلاً جديداً" }, ar_verb: { past: ["بدأتُ","بدأتَ","بدأ","بدأنا","بدأتم","بدأوا"], present: ["أبدأُ","تبدأُ","يبدأُ","نبدأُ","تبدأون","يبدأون"] } },
            "شکستن": { stem: "شکن", category: "action_transitive", object: { fa: "یک لیوان را", ar: "كأساً" }, ar_verb: { past: ["كسرتُ","كسرتَ","كسر","كسرنا","كسرتم","كسروا"], present: ["أكسرُ","تكسرُ","يكسرُ","نكسرُ","تكسرون","يكسرون"] } },
            "صحبت کردن": { stem: "صحبت کن", category: "communication", prep_phrase: { fa: "درباره آینده", ar: "عن المستقبل" }, ar_verb: { past: ["تحدثتُ","تحدثتَ","تحدث","تحدثنا","تحدثتم","تحدثوا"], present: ["أتحدثُ","تتحدثُ","يتحدثُ","نتحدثُ","تتحدثون","يتحدثون"] } },
            "فروختن": { stem: "فروش", category: "transaction", object: { fa: "ماشین قدیمی را", ar: "السيارة القديمة" }, ar_verb: { past: ["بعتُ","بعتَ","باع","بعنا","بعتم","باعوا"], present: ["أبيعُ","تبيعُ","يبيعُ","نبيعُ","تبيعون","يبيعون"] } },
            "فکر کردن": { stem: "فکر کن", category: "cognition", prep_phrase: { fa: "به گذشته", ar: "في الماضي" }, ar_verb: { past: ["فكرتُ", "فكرتَ", "فكر", "فكرنا", "فكرتم", "فكروا"], present: ["أفكرُ", "تفكرُ", "يفكرُ", "نفكرُ", "تفكرون", "يفكرون"] } },
            "فهمیدن": { stem: "فهم", category: "cognition", object: { fa: "درس را به خوبی", ar: "الدرس جيداً" }, ar_verb: { past: ["فهمتُ","فهمتَ","فهم","فهمنا","فهمتم","فهموا"], present: ["أفهمُ","تفهمُ","يفهمُ","نفهمُ","تفهمون","يفهمون"] } },
            "کار کردن": { stem: "کار کن", category: "action_intransitive", prep_phrase: { fa: "در یک شرکت", ar: "في شركة" }, ar_verb: { past: ["عملتُ", "عملتَ", "عمل", "عملنا", "عملتم", "عملوا"], present: ["أعملُ", "تعملُ", "يعملُ", "نعملُ", "تعملون", "يعملون"] } },
            "کشتن": { stem: "کش", category: "action_transitive", object: { fa: "وقت را", ar: "الوقت" }, ar_verb: { past: ["قتلتُ","قتلتَ","قتل","قتلنا","قتلتم","قتلوا"], present: ["أقتلُ","تقتلُ","يقتلُ","نقتلُ","تقتلون","يقتلون"] } },
            "کمک کردن": { stem: "کمک کن", category: "social", prep_phrase: { fa: "به نیازمندان", ar: "للمحتاجين" }, ar_verb: { past: ["ساعدتُ","ساعدتَ","ساعد","ساعدنا","ساعدتم","ساعدوا"], present: ["أساعدُ","تساعدُ","يساعدُ","نساعدُ","تساعدون","يساعدون"] } },
            "کنار زدن": { stem: "کنار زن", category: "action_transitive", object: { fa: "پرده را", ar: "الستار" }, ar_verb: { past: ["أزحتُ","أزحتَ","أزاح","أزحنا","أزحتم","أزاحوا"], present: ["أُزيحُ","تُزيحُ","يُزيحُ","نُزيحُ","تُزيحون","يُزيحون"] } },
            "گذاشتن": { stem: "گذار", category: "action_transitive", object: { fa: "کتاب را روی میز", ar: "الكتاب على الطاولة" }, ar_verb: { past: ["وضعتُ", "وضعتَ", "وضع", "وضعنا", "وضعتم", "وضعوا"], present: ["أضعُ", "تضعُ", "يضعُ", "نضعُ", "تضعون", "يضعون"] } },
            "گرفتن": { stem: "گیر", category: "possession", object: { fa: "یک عکس", ar: "صورة" }, ar_verb: { past: ["التقطتُ", "التقطتَ", "التقط", "التقطنا", "التقطتم", "التقطوا"], present: ["ألتقطُ", "تلتقطُ", "يلتقطُ", "نلتقطُ", "تلتقطون", "يلتقطون"] } },
            "گفتن": { stem: "گو", category: "communication", object: { fa: "یک داستان را", ar: "قصة" }, ar_verb: { past: ["حكيتُ","حكيتَ","حكى","حكينا","حكيتم","حكوا"], present: ["أحكي","تحكي","يحكي","نحكي","تحكون","يحكون"] } },
            "گم شدن": { stem: "گم شو", category: "state_intransitive", prep_phrase: { fa: "در جنگل", ar: "في الغابة" }, ar_verb: { past: ["ضعتُ","ضعتَ","ضاع","ضعنا","ضعتم","ضاعوا"], present: ["أضيعُ","تضيعُ","يضيعُ","نضيعُ","تضيعون","يضيعون"] } },
            "گم کردن": { stem: "گم کن", category: "action_transitive", object: { fa: "راه را", ar: "الطريق" }, ar_verb: { past: ["أضعتُ", "أضعتَ", "أضاع", "أضعنا", "أضعتم", "أضاعوا"], present: ["أُضيعُ", "تُضيعُ", "يُضيعُ", "نُضيعُ", "تُضيعون", "يُضيعون"] } },
            "گوش دادن": { stem: "گوش ده", category: "perception", prep_phrase: { fa: "به پادکست", ar: "للبودكاست" }, ar_verb: { past: ["استمعتُ", "استمعتَ", "استمع", "استمعنا", "استمعتم", "استمعوا"], present: ["أستمعُ", "تستمعُ", "يستمعُ", "نستمعُ", "تستمعون", "يستمعون"] } },
            "مردن": { stem: "میر", category: "state_intransitive", prep_phrase: { fa: "از خنده", ar: "من الضحك" }, ar_verb: { past: ["متُّ","متَّ","مات","متنا","متم","ماتوا"], present: ["أموتُ","تموتُ","يموتُ","نموتُ","تموتون","يموتون"] } },
            "نشستن": { stem: "نشین", category: "state_intransitive", prep_phrase: { fa: "کنار پنجره", ar: "بجانب النافذة" }, ar_verb: { past: ["جلستُ", "جلستَ", "جلس", "جلسنا", "جلستم", "جلسوا"], present: ["أجلسُ", "تجلسُ", "يجلسُ", "نجلسُ", "تجلسون", "يجلسون"] } },
            "نگاه کردن": { stem: "نگاه کن", category: "perception", prep_phrase: { fa: "به آسمان", ar: "إلى السماء" }, ar_verb: { past: ["نظرتُ", "نظرتَ", "نظر", "نظرنا", "نظرتم", "نظروا"], present: ["أنظرُ", "تنظرُ", "ينظرُ", "ننظرُ", "تنظرون", "ينظرون"] } },
            "نوشتن": { stem: "نویس", category: "creation", object: { fa: "یک نامه", ar: "رسالة" }, ar_verb: { past: ["كتبتُ","كتبتَ","كتب","كتبنا","كتبتم","كتبوا"], present: ["أكتبُ","تكتبُ","يكتبُ","نكتبُ","تكتبون","يكتبون"] } },
            "یاد گرفتن": { stem: "یاد گیر", category: "cognition", object: { fa: "یک زبان جدید", ar: "لغة جديدة" }, ar_verb: { past: ["تعلمتُ", "تعلمتَ", "تعلم", "تعلمنا", "تعلمتم", "تعلموا"], present: ["أتعلمُ", "تتعلمُ", "يتعلمُ", "نتعلمُ", "تتعلمون", "يتعلمون"] } },
            "یاد دادن": { stem: "یاد ده", category: "communication", object: { fa: "یک درس مهم", ar: "درساً مهماً" }, ar_verb: { past: ["علمتُ", "علمتَ", "علم", "علمنا", "علمتم", "علموا"], present: ["أُعلمُ", "تُعلمُ", "يُعلمُ", "نُعلمُ", "تُعلمون", "يُعلمون"] } }
        };

        // --- LOGIC ---
        let lastConjugationData = {};
        
        const elements = {};
        const elementIds = ['verb-select', 'verb-input', 'conjugate-btn', 'btn-text', 'conjugation-table', 'table-body', 'verb-info', 'examples-section', 'present-examples-btn', 'past-examples-btn', 'sentences-container', 'correction-notice', 'error-notice', 'results-container'];
        elementIds.forEach(id => { elements[id.replace(/-(\w)/g, (_, p1) => p1.toUpperCase())] = document.getElementById(id); });
        
        function toggleLoading(isLoading) {
            elements.conjugateBtn.querySelector('.loader').style.display = isLoading ? 'inline-block' : 'none';
            elements.btnText.textContent = isLoading ? 'جارِ التصريف...' : 'صَرّف الفعل';
            elements.conjugateBtn.disabled = isLoading;
        }

        function showResults(show) {
            if (show) {
                elements.errorNotice.style.display = 'none';
                elements.resultsContainer.classList.add('visible-results');
                elements.resultsContainer.classList.remove('hidden-results');
            } else {
                elements.resultsContainer.classList.remove('visible-results');
                elements.resultsContainer.classList.add('hidden-results');
            }
        }

        function showError(message) {
            elements.errorNotice.innerHTML = message;
            elements.errorNotice.style.display = 'block';
            showResults(false);
        }

        function levenshtein(a,b){if(a.length==0)return b.length;if(b.length==0)return a.length;const m=Array(b.length+1).fill(null).map(()=>Array(a.length+1).fill(null));for(let i=0;i<=a.length;i++){m[0][i]=i}for(let j=0;j<=b.length;j++){m[j][0]=j}for(let j=1;j<=b.length;j++){for(let i=1;i<=a.length;i++){const c=a[i-1]===b[j-1]?0:1;m[j][i]=Math.min(m[j][i-1]+1,m[j-1][i]+1,m[j-1][i-1]+c)}}return m[b.length][a.length]}
        function autoCorrect(verb){const allKnownVerbs=[...Object.keys(verbData)];if(allKnownVerbs.includes(verb))return{correctedVerb:verb,wasCorrected:false};let bestMatch=null,minDistance=2;for(const knownVerb of allKnownVerbs){const distance=levenshtein(verb,knownVerb);if(distance<minDistance){minDistance=distance;bestMatch=knownVerb}}return{correctedVerb:bestMatch||verb,wasCorrected:!!bestMatch}}
        
        function normalizePersianChars(text) {
            if (!text) return "";
            return text.replace(/ي/g, 'ی').replace(/ك/g, 'ک');
        }

        function deriveStems(verbPart) {
            if (!verbPart || !verbPart.endsWith('ن')) return null; const pastStem = verbPart.slice(0, -1); let presentStem = null; if (verbPart.endsWith('اختن')) { presentStem = pastStem.slice(0, -2) + 'از'; } else if (verbPart.endsWith('اشتن')) { presentStem = pastStem.slice(0, -2) + 'ار'; } else if (verbPart.endsWith('افتن')) { presentStem = pastStem.slice(0, -2) + 'اب'; } else if (verbPart.endsWith('وختن')) { presentStem = pastStem.slice(0, -3) + 'وش'; } else if (verbPart.endsWith('ودن')) { if (verbPart.endsWith('سودن')) { presentStem = pastStem.slice(0, -2) + 'ا'; } else { presentStem = pastStem.slice(0, -2) + 'ای'; } } else if (verbPart.endsWith('ادن')) { presentStem = pastStem.slice(0, -1); } else if (verbPart.endsWith('ستن')) { if (verbPart === 'شستن') { presentStem = 'شو'; } else if (verbPart.endsWith('سستن')) { presentStem = pastStem.slice(0, -2) + 'ل'; } else { presentStem = pastStem.slice(0, -1); } } else if (verbPart.endsWith('اندن')) { presentStem = pastStem.slice(0, -2) + 'ان'; } else if (verbPart.endsWith('ردن')) { if (pastStem.endsWith('کرد')) { presentStem = pastStem.slice(0, -2) + 'ن'; } else { presentStem = pastStem.slice(0, -2) + 'ر'; } } else if (verbPart.endsWith('فتن')) { if (verbPart === 'رفتن') { presentStem = 'رو'; } else if (verbPart === 'گرفتن') { presentStem = 'گیر'; } else { presentStem = pastStem.slice(0, -2) + 'ب'; } } else if (verbPart.endsWith('شتن')) { presentStem = pastStem.slice(0, -2) + 'ر'; } else if (verbPart.endsWith('یدن')) { presentStem = pastStem.slice(0, -2); } if (presentStem) { return { pastStem, presentStem }; } return null;
        }

        function conjugate(infinitive) { 
            const finalInfinitive = infinitive.trim(); 
            if (!finalInfinitive) return false; 
            lastConjugationData = { infinitive: finalInfinitive };
            const isCompound = finalInfinitive.includes(' ');
            let nounPart = '', verbPart = finalInfinitive, pastStem, presentStem; 
            if (isCompound) { const parts = finalInfinitive.split(' '); nounPart = parts.slice(0, -1).join(' ') + ' '; verbPart = parts[parts.length - 1]; }
            let stemsFound = false; 
            if (verbData[finalInfinitive]) { 
                pastStem = verbPart.slice(0, -1); 
                presentStem = verbData[finalInfinitive].stem.replace(nounPart, ''); 
                stemsFound = true; 
            } else { 
                const derived = deriveStems(verbPart); 
                if (derived) { pastStem = derived.pastStem; presentStem = derived.presentStem; stemsFound = true; } 
            } 
            if (!stemsFound) { 
                showError(`الفعل <strong class="persian-text">"${finalInfinitive}"</strong> شاذ جداً أو غير صحيح. لم يتمكن المحرك الذكي من اشتقاقه.`);
                return false; 
            } 
            const fullPastStem = nounPart + pastStem, fullPresentStem = nounPart + presentStem; 
            elements.verbInfo.innerHTML = `<span class="persian-text">المصدر: <span class="fw-bold">${finalInfinitive}</span></span> | <span class="persian-text">الماضي: <span class="fw-bold">${fullPastStem}</span></span> | <span class="persian-text">المضارع: <span class="fw-bold">${fullPresentStem}</span></span>`; 
            elements.verbInfo.style.display = 'block'; 
            const pastEndings = ['م', 'ی', '', 'یم', 'ید', 'ند'], presentEndings = ['م', 'ی', 'د', 'یم', 'ید', 'ند']; 
            lastConjugationData.past = pastEndings.map(e => nounPart + pastStem + e); 
            lastConjugationData.present = presentEndings.map(e => (nounPart ? nounPart + 'می‌' : 'می‌') + presentStem + e); 
            lastConjugationData.imperative = generateImperative(verbPart, presentStem, nounPart, isCompound); 
            displayTable(lastConjugationData); 
            return true; 
        }

        function generateImperative(verbPart, presentStem, nounPart, isCompound) { let s, p; if (verbPart === 'داشتن') { s = 'داشته باش'; p = 'داشته باشید'; } else if (verbPart === 'بودن') { s = 'باش'; p = 'باشید'; } else if (verbPart === 'آمدن') { s = 'بیا'; p = 'بیایید'; } else { s = (isCompound || presentStem.startsWith('آ')) ? presentStem : `ب${presentStem}`; p = (isCompound || presentStem.startsWith('آ')) ? presentStem + 'ید' : `ب${presentStem}ید`; } return ['', nounPart + s, '', '', nounPart + p, '']; }
        function displayTable(data) { elements.tableBody.innerHTML = ''; pronouns.forEach((p, i) => { const row = document.createElement('tr'); row.innerHTML = `<td class="pronoun-col">${p.fa}<br><small>(${p.ar})</small></td><td>${data.past[i]}</td><td>${data.present[i]}</td><td>${data.imperative[i] || '—'}</td>`; elements.tableBody.appendChild(row); }); showResults(true); }
        
        function generateSmartSentences(tense) {
            const infinitive = lastConjugationData.infinitive;
            const verbs = lastConjugationData[tense];
            const verbInfo = verbData[infinitive];

            let sentenceParts = { fa: "آن را", ar: "ذلك" };
            let arVerbConjugations = null;
            let sentenceStructure = "S_O_V";
            
            if (verbInfo) {
                arVerbConjugations = verbInfo.ar_verb ? verbInfo.ar_verb[tense] : null;
                if (verbInfo.object) { sentenceParts = verbInfo.object; sentenceStructure = "S_O_V"; } 
                else if (verbInfo.prep_phrase) { sentenceParts = verbInfo.prep_phrase; sentenceStructure = "S_PP_V"; } 
                else if (verbInfo.complement) { sentenceParts = verbInfo.complement; sentenceStructure = "S_C_V"; } 
                else if (verbInfo.infinitive_phrase) { sentenceParts = verbInfo.infinitive_phrase; sentenceStructure = "S_IV_V"; }
            } else {
                if (infinitive.endsWith(' شدن')) { sentenceStructure = "S_V"; }
            }

            let sentencesHTML = '<ul>';
            pronouns.forEach((p, i) => {
                let persianSentence = "";
                let arabicSentence = "";

                switch(sentenceStructure) {
                    case "S_O_V": persianSentence = `${p.fa} ${sentenceParts.fa} ${verbs[i]}`; break;
                    case "S_PP_V": persianSentence = `${p.fa} ${sentenceParts.fa} ${verbs[i]}`; break;
                    case "S_C_V": persianSentence = `${p.fa} ${sentenceParts.fa} ${verbs[i].replace(/می‌|می/g, "")}`; break;
                    case "S_V": persianSentence = `${p.fa} ${verbs[i]}`; break;
                    default: persianSentence = `${p.fa} ${sentenceParts.fa} ${verbs[i]}`;
                }

                if (arVerbConjugations && arVerbConjugations[i]) {
                    arabicSentence = `${p.ar} ${arVerbConjugations[i]} ${sentenceParts.ar}`;
                } else {
                    arabicSentence = "لا تتوفر ترجمة آلية لهذا الفعل.";
                }

                sentencesHTML += `<li><span class="persian-text">${persianSentence.trim()}.</span> <span class="arabic-translation">(${arabicSentence.trim()})</span></li>`;
            });
            sentencesHTML += '</ul>';
            elements.sentencesContainer.innerHTML = sentencesHTML;
            elements.sentencesContainer.style.display = 'block';
        }
        
        function handleRequest(source) {
            let verb = source.value;
            verb = normalizePersianChars(verb).trim();
            if (!verb) return;
            
            toggleLoading(true);
            
            // ** تم إزالة منطق VIP للسماح للمحرك الجديد بالعمل دائماً **
            
            setTimeout(() => {
                const { correctedVerb, wasCorrected } = autoCorrect(verb);
                if (wasCorrected) {
                    elements.correctionNotice.innerHTML = `هل تقصد <strong class="persian-text">"${correctedVerb}"</strong>؟ تم التصحيح تلقائيًا.`;
                    elements.correctionNotice.style.display = 'block';
                    verb = correctedVerb;
                    source.value = verb;
                } else {
                    elements.correctionNotice.style.display = 'none';
                }

                if (source.id === 'verb-input') { elements.verbSelect.value = ''; } else { elements.verbInput.value = ''; }
                
                conjugate(verb);
                
                toggleLoading(false);
            }, 50);
        }

        // --- INIT & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            const allVerbs = Object.keys(verbData).sort((a, b) => a.localeCompare(b, 'fa'));
            let optionsHtml = '<option value="">-- اختر فعلاً من القائمة --</option>';
            allVerbs.forEach(verb => { 
                optionsHtml += `<option value="${verb}">${verb}</option>`;
            });
            elements.verbSelect.innerHTML = optionsHtml;
            
            elements.verbSelect.addEventListener('change', () => handleRequest(elements.verbSelect));
            elements.conjugateBtn.addEventListener('click', () => handleRequest(elements.verbInput));
            
            elements.verbInput.addEventListener('input', (e) => {
                const originalValue = e.target.value;
                const normalizedValue = normalizePersianChars(originalValue);
                if (originalValue !== normalizedValue) {
                    const cursorPos = e.target.selectionStart;
                    e.target.value = normalizedValue;
                    e.target.setSelectionRange(cursorPos, cursorPos);
                }
            });

            elements.verbInput.addEventListener('keypress', (e) => { if (e.key === "Enter") { e.preventDefault(); handleRequest(elements.verbInput); } });
            
            elements.pastExamplesBtn.addEventListener('click', () => generateSmartSentences('past'));
            elements.presentExamplesBtn.addEventListener('click', () => generateSmartSentences('present'));
        });
    </script>
</body>
</html>
